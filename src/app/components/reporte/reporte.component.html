<div class="reportes-container">
  <div class="reportes-content">

    <!-- Header -->
    <div class="header">
      <div class="header-content">
        <h1>ğŸ“Š {{ analisisId ? 'Reporte Detallado del AnÃ¡lisis' : 'Historial de AnÃ¡lisis' }}</h1>
        <p>{{ analisisId ? 'CaracterÃ­sticas completas del anÃ¡lisis de phishing' : 'Visualiza estadÃ­sticas detalladas y grÃ¡ficos del anÃ¡lisis de phishing' }}</p>
      </div>
      <div class="header-actions">
        <button class="btn-action btn-volver" (click)="volverAlInicio()">
          â† Volver al Inicio
        </button>
        <button class="btn-action btn-exportar-pdf" (click)="exportarPDF()">
          ğŸ“¥ Exportar PDF
        </button>
      </div>
    </div>

    <!-- Loading State -->
    <div class="loading-state" *ngIf="cargando">
      <div class="spinner"></div>
      <p>Cargando datos del reporte...</p>
    </div>

    <!-- Contenido del Reporte -->
    <div class="reporte-content" *ngIf="!cargando">

      <!-- AnÃ¡lisis Actual (si existe) -->
      <div class="analisis-detalle-card" *ngIf="analisisActual">
        <div class="card-header-detalle">
          <h2>ğŸ” AnÃ¡lisis Detallado</h2>
          <span class="badge-resultado"
                [ngClass]="analisisActual.isPhishing ? 'badge-peligro' : 'badge-seguro'">
            {{ analisisActual.isPhishing ? 'âš ï¸ PHISHING DETECTADO' : 'âœ… SITIO SEGURO' }}
          </span>
        </div>

        <div class="detalle-grid">
          <div class="detalle-item full-width">
            <span class="detalle-label">ğŸ”— URL Analizada:</span>
            <span class="detalle-value url-value">{{ analisisActual.urlEnlace || analisisActual.enlaceUrl }}</span>
          </div>

          <div class="detalle-item">
            <span class="detalle-label">ğŸ“… Fecha de AnÃ¡lisis:</span>
            <span class="detalle-value">
              {{ analisisActual.analysisTimestamp || analisisActual.fecha | date:'dd/MM/yyyy HH:mm:ss' }}
            </span>
          </div>

          <div class="detalle-item">
            <span class="detalle-label">ğŸ“Š Probabilidad de Phishing:</span>
            <span class="detalle-value confianza-badge" [ngClass]="getConfianzaClass(analisisActual.probabilityPhishing || analisisActual.confianza)">
              {{ ((analisisActual.probabilityPhishing || analisisActual.confianza) * 100).toFixed(2) }}%
            </span>
          </div>

          <div class="detalle-item">
            <span class="detalle-label">ğŸ¯ Nivel de Confianza:</span>
            <span class="detalle-value">{{ analisisActual.confidence }}</span>
          </div>

          <div class="detalle-item">
            <span class="detalle-label">ğŸ·ï¸ Etiqueta:</span>
            <span class="detalle-value">{{ analisisActual.label }}</span>
          </div>

          <div class="detalle-item">
            <span class="detalle-label">ğŸ“ Longitud de URL:</span>
            <span class="detalle-value">{{ analisisActual.urllength }} caracteres</span>
          </div>

          <div class="detalle-item">
            <span class="detalle-label">ğŸŒ Dominio:</span>
            <span class="detalle-value">{{ analisisActual.domain }}</span>
          </div>

          <div class="detalle-item">
            <span class="detalle-label">ğŸ“ Longitud del Dominio:</span>
            <span class="detalle-value">{{ analisisActual.domainLength }} caracteres</span>
          </div>

          <div class="detalle-item">
            <span class="detalle-label">ğŸ“‚ Longitud del Path:</span>
            <span class="detalle-value">{{ analisisActual.pathLength }} caracteres</span>
          </div>

          <div class="detalle-item">
            <span class="detalle-label">ğŸ”’ Protocolo:</span>
            <span class="detalle-value">{{ analisisActual.protocol }}</span>
          </div>

          <div class="detalle-item">
            <span class="detalle-label">âœ… Tiene HTTPS:</span>
            <span class="detalle-value">{{ analisisActual.hasHttps ? 'SÃ­' : 'No' }}</span>
          </div>

          <div class="detalle-item">
            <span class="detalle-label">â“ Tiene Query Params:</span>
            <span class="detalle-value">{{ analisisActual.hasQuery ? 'SÃ­' : 'No' }}</span>
          </div>

          <div class="detalle-item">
            <span class="detalle-label">ğŸ”¤ Caracteres Especiales:</span>
            <span class="detalle-value">{{ analisisActual.specialCharactersCount }}</span>
          </div>

          <div class="detalle-item">
            <span class="detalle-label">ğŸ”¢ DÃ­gitos en URL:</span>
            <span class="detalle-value">{{ analisisActual.digitsInUrl }}</span>
          </div>

          <div class="detalle-item">
            <span class="detalle-label">ğŸ”¢ DÃ­gitos en Dominio:</span>
            <span class="detalle-value">{{ analisisActual.digitsInDomain }}</span>
          </div>

          <div class="detalle-item">
            <span class="detalle-label">ğŸ” DÃ­gitos Repetidos:</span>
            <span class="detalle-value">{{ analisisActual.hasRepeatedDigits ? 'SÃ­' : 'No' }}</span>
          </div>

          <div class="detalle-item">
            <span class="detalle-label">ğŸŒ NÃºmero de Subdominios:</span>
            <span class="detalle-value">{{ analisisActual.numberOfSubdomains }}</span>
          </div>

          <div class="detalle-item">
            <span class="detalle-label">â€¢ Puntos en Dominio:</span>
            <span class="detalle-value">{{ analisisActual.dotsInDomain }}</span>
          </div>

          <div class="detalle-item">
            <span class="detalle-label">- Guiones en Dominio:</span>
            <span class="detalle-value">{{ analisisActual.hyphensInDomain }}</span>
          </div>

          <div class="detalle-item">
            <span class="detalle-label">âš ï¸ Palabras Sospechosas:</span>
            <span class="detalle-value">{{ analisisActual.suspiciousKeywordsCount }}</span>
          </div>

          <div class="detalle-item full-width" *ngIf="analisisActual.suspiciousKeywords">
            <span class="detalle-label">ğŸ” Lista de Palabras Sospechosas:</span>
            <span class="detalle-value">{{ analisisActual.suspiciousKeywords }}</span>
          </div>

          <div class="detalle-item">
            <span class="detalle-label">â±ï¸ Tiempo de Respuesta API:</span>
            <span class="detalle-value">{{ analisisActual.apiResponseTime }} ms</span>
          </div>

          <div class="detalle-item">
            <span class="detalle-label">ğŸ“Œ VersiÃ³n de AnÃ¡lisis:</span>
            <span class="detalle-value">{{ analisisActual.analysisVersion }}</span>
          </div>

          <div class="detalle-item full-width" *ngIf="analisisActual.message">
            <span class="detalle-label">ğŸ’¬ Mensaje:</span>
            <span class="detalle-value">{{ analisisActual.message }}</span>
          </div>

          <div class="detalle-item full-width" *ngIf="analisisActual.recommendation">
            <span class="detalle-label">ğŸ’¡ RecomendaciÃ³n:</span>
            <span class="detalle-value">{{ analisisActual.recommendation }}</span>
          </div>
        </div>
      </div>

      <!-- EstadÃ­sticas Generales -->
      <div class="estadisticas-section">
        <h2 class="section-title">ğŸ“ˆ EstadÃ­sticas Generales</h2>

        <div class="estadisticas-grid">
          <!-- Total de AnÃ¡lisis -->
          <div class="stat-card stat-total">
            <div class="stat-icon">ğŸ“Š</div>
            <div class="stat-info">
              <div class="stat-number">{{ totalAnalisis }}</div>
              <div class="stat-label">Total de AnÃ¡lisis</div>
            </div>
          </div>

          <!-- Phishing Detectado -->
          <div class="stat-card stat-phishing">
            <div class="stat-icon">âš ï¸</div>
            <div class="stat-info">
              <div class="stat-number">{{ phishingDetectado }}</div>
              <div class="stat-label">Phishing Detectado</div>
            </div>
          </div>

          <!-- Sitios Seguros -->
          <div class="stat-card stat-seguro">
            <div class="stat-icon">âœ…</div>
            <div class="stat-info">
              <div class="stat-number">{{ seguros }}</div>
              <div class="stat-label">Sitios Seguros</div>
            </div>
          </div>

          <!-- Porcentaje de Amenazas -->
          <div class="stat-card stat-porcentaje">
            <div class="stat-icon">ğŸ¯</div>
            <div class="stat-info">
              <div class="stat-number">{{ porcentajePhishing }}%</div>
              <div class="stat-label">% de Amenazas</div>
            </div>
          </div>
        </div>
      </div>

      <!-- GrÃ¡ficos -->
      <div class="graficos-section">
        <h2 class="section-title">ğŸ“Š VisualizaciÃ³n de Datos</h2>

        <div class="graficos-grid">
          <!-- GrÃ¡fico de Riesgo Actual -->
          <div class="grafico-card" *ngIf="analisisActual">
            <div class="grafico-header">
              <h3>Nivel de Riesgo Actual</h3>
              <p class="grafico-descripcion">EvaluaciÃ³n del anÃ¡lisis reciente</p>
            </div>
            <div class="grafico-container">
              <canvas id="chartRiesgo"></canvas>
            </div>
          </div>

          <!-- GrÃ¡fico de Historial -->
          <div class="grafico-card" *ngIf="historialAnalisis.length > 0">
            <div class="grafico-header">
              <h3>DistribuciÃ³n de AnÃ¡lisis</h3>
              <p class="grafico-descripcion">Phishing vs Sitios Seguros</p>
            </div>
            <div class="grafico-container">
              <canvas id="chartHistorial"></canvas>
            </div>
          </div>

          <!-- GrÃ¡fico de CaracterÃ­sticas -->
          <div class="grafico-card grafico-full" *ngIf="analisisActual">
            <div class="grafico-header">
              <h3>AnÃ¡lisis de CaracterÃ­sticas de la URL</h3>
              <p class="grafico-descripcion">Indicadores de seguridad evaluados</p>
            </div>
            <div class="grafico-container">
              <canvas id="chartCaracteristicas"></canvas>
            </div>
          </div>
        </div>
      </div>

      <!-- Tabla de Historial - SOLO si NO hay analisisId especÃ­fico -->
      <div class="historial-section" *ngIf="historialAnalisis.length > 1">
        <div class="section-header">
          <h2 class="section-title">ğŸ“‹ Historial de AnÃ¡lisis</h2>
          <div class="historial-info">
            <span class="info-badge">Mostrando {{ historialAnalisis.length }} registros</span>
          </div>
        </div>

        <div class="tabla-wrapper">
          <table class="tabla-historial">
            <thead>
              <tr>
                <th>#</th>
                <th>Fecha</th>
                <th>URL</th>
                <th>Resultado</th>
                <th>Confianza</th>
                <th>Acciones</th>
              </tr>
            </thead>
            <tbody>
              <tr *ngFor="let analisis of historialAnalisis; let i = index"
                  [ngClass]="analisis.isPhishing ? 'row-phishing' : 'row-seguro'">
                <td class="td-index">{{ i + 1 }}</td>
                <td class="td-fecha">
                  {{ analisis.analysisTimestamp || analisis.fecha | date:'dd/MM/yyyy HH:mm' }}
                </td>
                <td class="td-url">
                  <a class="url-link"
                     [title]="analisis.urlEnlace || analisis.enlaceUrl"
                     (click)="verAnalisisEspecifico(analisis.enlaceId ?? analisis.id ?? 0)"
                     *ngIf="analisis.enlaceId || analisis.id">
                    {{ analisis.urlEnlace || analisis.enlaceUrl }}
                  </a>
                  <span class="url-truncate" *ngIf="!analisis.enlaceId && !analisis.id">
                    {{ analisis.urlEnlace || analisis.enlaceUrl }}
                  </span>
                </td>
                <td>
                  <span class="badge-resultado-tabla"
                        [ngClass]="analisis.isPhishing ? 'badge-danger' : 'badge-success'">
                    {{ analisis.isPhishing ? 'âš ï¸ Phishing' : 'âœ… Seguro' }}
                  </span>
                </td>
                <td>
                  <div class="confianza-container">
                    <span class="confianza-valor">
                      {{ ((analisis.probabilityPhishing || analisis.confianza) * 100).toFixed(1) }}%
                    </span>
                    <div class="confianza-barra">
                      <div class="confianza-progreso"
                           [style.width.%]="(analisis.probabilityPhishing || analisis.confianza) * 100"
                           [ngClass]="getConfianzaClass(analisis.probabilityPhishing || analisis.confianza)">
                      </div>
                    </div>
                  </div>
                </td>
                <td>
                  <div class="acciones-grupo">
                    <button class="btn-mini btn-ver"
                            (click)="verDetallesAnalisis(analisis)"
                            title="Ver detalles">
                      ğŸ‘ï¸
                    </button>
                    <button class="btn-mini btn-eliminar"
                            (click)="eliminarAnalisis(analisis)"
                            title="Eliminar anÃ¡lisis">
                      ğŸ—‘ï¸
                    </button>
                  </div>
                </td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>

      <!-- Estado VacÃ­o -->
      <div class="empty-state" *ngIf="!analisisActual && historialAnalisis.length === 0">
        <div class="empty-icon">ğŸ“Š</div>
        <h3 class="empty-title">No hay datos para mostrar</h3>
        <p class="empty-subtitle">Realiza un anÃ¡lisis primero para ver el reporte completo</p>
        <button class="btn-empty" (click)="volverAlInicio()">
          Ir al Analizador
        </button>
      </div>

    </div>
  </div>
</div>
